<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>綠野尋蹤 Green Pet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .app-bg {
            background: linear-gradient(to bottom, #87CEEB 0%, #a8e0f7 70%, #98D8AA 70%, #8BC34A 100%);
            position: relative;
            overflow: hidden;
        }
        .main-content { z-index: 1; position: relative; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .modal-backdrop { transition: opacity 0.3s ease; opacity: 0; }
        .modal-backdrop.opacity-100 { opacity: 1; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        input[type="file"] { display: none; }
        .nav-item.active { color: #16a34a; /* emerald-600 */ }
        .achievement-unlocked { background-color: #d1fae5; border-color: #10b981; }
        .task-completed { text-decoration: line-through; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto h-[800px] max-h-[90vh] bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">

        <!-- Screens Container -->
        <div id="screen-container" class="flex-grow relative">
            <!-- 1. 主頁畫面 (Home Screen) -->
            <div id="home-screen" class="w-full h-full flex flex-col app-bg">
                <header class="p-4 flex justify-between items-center z-10">
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-4 py-1 flex items-center shadow">
                        <span id="level-text" class="font-bold text-emerald-700 mr-3">Lv.1</span>
                        <div class="w-24 bg-gray-300 rounded-full h-4"><div id="xp-bar" class="bg-gradient-to-r from-yellow-400 to-amber-500 h-4 rounded-full" style="width: 0%;"></div></div>
                        <span id="xp-value" class="text-xs font-bold text-gray-600 ml-2">0/10</span>
                    </div>
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-3 py-2 flex items-center shadow">
                        <span class="text-2xl">🌿</span>
                        <span id="seed-count" class="font-bold text-emerald-700 ml-2">10</span>
                    </div>
                </header>
                <main class="flex-grow flex flex-col justify-end items-center main-content pb-4">
                    <div class="pet-container text-center">
                        <img id="pet-visual" src="http://googleusercontent.com/file_content/1" alt="電子寵物" class="h-64 w-auto drop-shadow-lg">
                        <p id="pet-name" class="mt-2 text-xl font-bold text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.4)">小種籽</p>
                    </div>
                </main>
            </div>

            <!-- Other Screens (hidden by default) -->
            <div id="loading-screen" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-20">
                 <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-500"></div>
                 <p class="mt-4 text-lg text-gray-600 font-semibold">AI 正在努力辨識中...</p>
            </div>

            <div id="result-screen" class="hidden absolute inset-0 bg-gray-50 flex flex-col p-4 sm:p-6 z-20">
                <h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-4">分析結果與挑戰</h2>
                <div class="bg-white p-4 rounded-lg mb-4 text-center shadow-sm">
                    <img id="uploaded-image" src="" alt="上傳的植物圖片" class="max-h-40 w-auto mx-auto rounded-lg shadow-md mb-3">
                    <p class="text-sm text-gray-500">辨識結果：</p>
                    <p id="plant-name-result" class="text-lg font-bold text-emerald-600"></p>
                    <p id="plant-fact" class="text-sm mt-2 text-gray-700 bg-emerald-50 p-2 rounded-md"></p>
                </div>
                <div class="bg-amber-50 p-4 rounded-lg shadow-sm">
                    <p class="font-semibold text-amber-800 mb-3 text-center">💡 生態小測驗</p>
                    <p id="quiz-question" class="mb-4 text-center"></p>
                    <div id="quiz-options" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>

            <div id="tasks-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20">
                <h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">任務中心</h2>
                <div id="tasks-list"></div>
            </div>

            <div id="achievements-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20">
                 <h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">我的成就</h2>
                 <div id="achievements-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="w-full bg-gray-100/90 backdrop-blur-sm grid grid-cols-4 gap-1 p-2 border-t border-gray-200 z-10">
            <button id="nav-home" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg active"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span class="text-xs font-medium">主頁</span></button>
            <label for="plant-input" class="nav-item btn flex flex-col items-center text-gray-600 p-1 rounded-lg cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg><span class="text-xs font-medium">餵飼</span></label>
            <input type="file" id="plant-input" accept="image/*">
            <button id="nav-tasks" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg><span class="text-xs font-medium">任務</span></button>
            <button id="nav-achievements" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v4m-2-2h4m6 4v4m-2-2h4M17 3l-1.5 1.5M21 7l-1.5-1.5M17 21l-1.5-1.5M21 17l-1.5 1.5M3 7l1.5-1.5M7 3l1.5 1.5M3 17l1.5 1.5M7 21l1.5-1.5" /></svg><span class="text-xs font-medium">成就</span></button>
        </nav>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm mx-auto transform scale-95 opacity-0">
            <div id="modal-icon" class="text-6xl mb-4"></div><h3 id="modal-title" class="text-2xl font-bold mb-2"></h3><p id="modal-message" class="text-gray-600 mb-6"></p><button id="modal-close-btn" class="btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-full">繼續</button>
        </div>
    </div>

<script>
    // --- Game State ---
    let gameState = {
        level: 1,
        xp: 0,
        seeds: 10,
        pet: {
            stage: 'seed',
            name: '小種籽',
            visual: 'http://googleusercontent.com/file_content/1',
        },
        stats: {
            feeds: 0,
            correctAnswers: 0,
        },
        tasks: {
            dailyFeed: {
                description: "每日餵飼寵物一次",
                reward: 5, // 5 seeds
                completedToday: false,
                claimedToday: false,
                lastFeedDate: null,
            }
        },
        achievements: {
            firstAnswer: { name: "初為人師", description: "第一次成功回答問題", target: 1, progress: 0, unlocked: false, metric: 'correctAnswers' },
            feedThreeTimes: { name: "小小農夫", description: "累計餵飼寵物 3 次", target: 3, progress: 0, unlocked: false, metric: 'feeds' },
            reachLevelTwo: { name: "初窺門徑", description: "寵物達到 2 級", target: 2, progress: 1, unlocked: false, metric: 'level' },
        },
        currentQuiz: null,
        isProcessing: false,
    };

    // --- DOM Element Variables (will be assigned on DOMContentLoaded) ---
    let navButtons, screens, petVisual, petName, levelText, xpBar, xpValue,
        seedCountText, plantInput, uploadedImage, plantNameResult,
        plantFact, quizQuestion, quizOptionsContainer, modal, modalIcon,
        modalTitle, modalMessage, modalCloseBtn;

    // --- Helper Functions ---
    const calculateXpToNextLevel = (level) => 8 + (2 * level);
    const getTodayString = () => new Date().toISOString().split('T')[0];

    // --- Navigation ---
    function navigateTo(screenName) {
        Object.values(screens).forEach(screen => {
            if (screen) screen.classList.add('hidden');
        });
        if (screens[screenName]) {
            screens[screenName].classList.remove('hidden');
        }

        Object.values(navButtons).forEach(btn => {
            if(btn) btn.classList.remove('active');
        });
        if (navButtons[screenName]) {
            navButtons[screenName].classList.add('active');
        }

        if (screenName === 'tasks') renderTasks();
        if (screenName === 'achievements') renderAchievements();
    }

    // --- Rendering ---
    function render() {
        const { level, xp, pet, seeds } = gameState;
        const xpToNextLevel = calculateXpToNextLevel(level);

        petVisual.src = pet.visual;
        petName.textContent = pet.name;
        levelText.textContent = `Lv.${level}`;
        seedCountText.textContent = seeds;
        xpValue.textContent = `${xp}/${xpToNextLevel}`;
        xpBar.style.width = `${Math.min((xp / xpToNextLevel) * 100, 100)}%`;
    }

    function renderTasks() {
        const list = document.getElementById('tasks-list');
        list.innerHTML = '';
        const task = gameState.tasks.dailyFeed;
        const taskEl = document.createElement('div');

        let buttonHtml;
        if (task.claimedToday) {
            buttonHtml = `<button class="btn px-4 py-2 rounded-full text-white bg-gray-400 cursor-not-allowed" disabled>已領取</button>`;
        } else if (task.completedToday) {
            buttonHtml = `<button id="claim-daily-feed" class="btn px-4 py-2 rounded-full text-white bg-green-500 hover:bg-green-600">領取</button>`;
        } else {
            buttonHtml = `<button class="btn px-4 py-2 rounded-full text-white bg-gray-400 cursor-not-allowed" disabled>未完成</button>`;
        }

        taskEl.className = `p-4 border rounded-lg shadow-sm ${task.claimedToday ? 'bg-gray-200' : 'bg-white'}`;
        taskEl.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-bold ${task.claimedToday ? 'task-completed' : ''}">${task.description}</p>
                    <p class="text-sm text-green-600">獎勵: ${task.reward} 🌿</p>
                </div>
                ${buttonHtml}
            </div>
        `;
        list.appendChild(taskEl);

        if (task.completedToday && !task.claimedToday) {
            document.getElementById('claim-daily-feed').addEventListener('click', claimDailyFeedReward);
        }
    }
    
    function claimDailyFeedReward() {
        const task = gameState.tasks.dailyFeed;
        if (task.completedToday && !task.claimedToday) {
            task.claimedToday = true;
            gameState.seeds += task.reward;
            showModal('🎉', '獎勵已領取！', `獲得 <b>${task.reward}</b> 🌿！`, () => {
                render();
                renderTasks();
            });
        }
    }

    function renderAchievements() {
        const list = document.getElementById('achievements-list');
        list.innerHTML = '';
        Object.values(gameState.achievements).forEach(ach => {
            const progress = Math.min(ach.progress, ach.target);
            const percentage = Math.floor((progress / ach.target) * 100);
            const achEl = document.createElement('div');
            achEl.className = `p-4 border rounded-lg shadow-sm ${ach.unlocked ? 'achievement-unlocked' : 'bg-white'}`;
            achEl.innerHTML = `
                <div class="flex items-center">
                    <div class="text-4xl mr-4">${ach.unlocked ? '🏆' : '⏳'}</div>
                    <div>
                        <p class="font-bold">${ach.name}</p>
                        <p class="text-sm text-gray-600">${ach.description}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="bg-yellow-400 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-xs text-right text-gray-500 mt-1">${progress} / ${ach.target}</p>
                    </div>
                </div>
            `;
            list.appendChild(achEl);
        });
    }

    // --- Modals & Notifications ---
    function showModal(icon, title, message, onClose = () => {}) {
        modalIcon.textContent = icon;
        modalTitle.textContent = title;
        modalMessage.innerHTML = message;
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('opacity-100');
            modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
        }, 10);
        const closeHandler = () => {
            hideModal();
            onClose();
            modalCloseBtn.removeEventListener('click', closeHandler);
        };
        modalCloseBtn.addEventListener('click', closeHandler);
    }
    function hideModal() {
        modal.classList.remove('opacity-100');
        modal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
        modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // --- Core Game Logic ---
    async function handleFileSelect(event) {
        if (gameState.isProcessing) return;
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            gameState.isProcessing = true;
            navigateTo('loading');

            gameState.stats.feeds++;
            checkAchievements('feeds', gameState.stats.feeds);
            const dailyFeedTask = gameState.tasks.dailyFeed;
            if (!dailyFeedTask.completedToday) {
                dailyFeedTask.completedToday = true;
                dailyFeedTask.lastFeedDate = getTodayString();
                setTimeout(() => showModal('🔔', '任務進度更新', '您已完成「每日餵飼」任務，記得到任務中心領取獎勵！'), 500);
            }
            render();

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                uploadedImage.src = reader.result;
                await identifyPlantAndCreateQuiz(base64Data);
            };
            reader.readAsDataURL(file);
        }
        event.target.value = '';
    }
    
    async function identifyPlantAndCreateQuiz(base64ImageData) {
        const prompt = `你是一位友善的植物學家和教育家。請辨識這張圖片中的主要植物，並提供以下資訊：
        1.  **植物名稱**：提供最可能的中文名稱。
        2.  **趣味知識**：提供一個關於此植物或相關生態的簡短、有趣的知識點（約30-50字）。
        3.  **生態測驗**：根據這個知識點或相關主題，設計一個簡單的單選題，包含一個正確答案和兩個明顯錯誤的答案。

        請嚴格按照以下JSON格式回傳，不要包含任何額外的文字或Markdown標記：
        {
          "plantName": "植物的中文名稱",
          "funFact": "一段簡短有趣的知識。",
          "quiz": {
            "question": "測驗問題的文字",
            "options": ["選項A", "選項B", "正確答案C"],
            "correctAnswerIndex": 2
          }
        }`;
        const API_KEY = ""; // Provided by environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const payload = {
            contents: [{
                role: "user",
                parts: [
                    { text: prompt },
                    { inlineData: { mimeType: "image/png", data: base64ImageData } }
                ]
            }],
            generationConfig: { responseMimeType: "application/json" }
        };
        try {
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`);
            const result = await response.json();
            const data = JSON.parse(result.candidates[0].content.parts[0].text);
            gameState.currentQuiz = data.quiz;
            displayResultAndQuiz(data);
        } catch (error) {
            console.error("API 處理錯誤:", error);
            showModal('😢', '分析失敗', '無法辨識圖片中的植物，請換一張更清晰的照片試試看。', () => {
                navigateTo('home');
                gameState.isProcessing = false;
            });
        }
    }

    function displayResultAndQuiz(data) {
        plantNameResult.textContent = data.plantName || "生態知識";
        plantFact.textContent = data.funFact || "準備好接受挑戰了嗎？";
        quizQuestion.textContent = data.quiz.question;
        quizOptionsContainer.innerHTML = '';
        data.quiz.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.textContent = option;
            button.className = 'btn w-full text-left p-3 bg-white hover:bg-amber-100 rounded-lg border border-amber-200';
            button.onclick = () => handleQuizAnswer(index);
            quizOptionsContainer.appendChild(button);
        });
        navigateTo('result');
        gameState.isProcessing = false;
    }

    function handleQuizAnswer(selectedIndex) {
        if (gameState.isProcessing) return;
        gameState.isProcessing = true;
        const isCorrect = selectedIndex === gameState.currentQuiz.correctAnswerIndex;
        if (isCorrect) {
            const xpReward = 2;
            gameState.xp += xpReward;
            gameState.stats.correctAnswers++;
            checkAchievements('correctAnswers', gameState.stats.correctAnswers);
            showModal('🎉', '答對了！', `太棒了！獲得了 <b>${xpReward}</b> 點經驗值。`, () => {
                checkLevelUp();
                navigateTo('home');
                gameState.isProcessing = false;
            });
        } else {
            showModal('🤔', '差一點！', '別灰心，再接再厲！', () => {
                navigateTo('home');
                gameState.isProcessing = false;
            });
        }
        render();
    }

    function checkLevelUp() {
        let xpToNextLevel = calculateXpToNextLevel(gameState.level);
        while (gameState.xp >= xpToNextLevel) {
            gameState.level++;
            gameState.xp -= xpToNextLevel;
            checkAchievements('level', gameState.level);
            showModal('🏆', '等級提升！', `恭喜升到 <b>Lv.${gameState.level}</b>！`);
            xpToNextLevel = calculateXpToNextLevel(gameState.level);
        }
    }

    function checkAchievements(metric, value) {
        Object.entries(gameState.achievements).forEach(([key, ach]) => {
            if (!ach.unlocked && ach.metric === metric) {
                ach.progress = value;
                if (ach.progress >= ach.target) {
                    ach.unlocked = true;
                    setTimeout(() => showModal('🌟', '成就解鎖！', `恭喜您達成「${ach.name}」！`), 500);
                }
            }
        });
    }
    
    function checkDailyTasks() {
        const today = getTodayString();
        const dailyFeedTask = gameState.tasks.dailyFeed;
        if (dailyFeedTask.lastFeedDate !== today) {
            dailyFeedTask.completedToday = false;
            dailyFeedTask.claimedToday = false;
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Assign DOM elements
        navButtons = {
            home: document.getElementById('nav-home'),
            tasks: document.getElementById('nav-tasks'),
            achievements: document.getElementById('nav-achievements'),
        };
        screens = {
            home: document.getElementById('home-screen'),
            loading: document.getElementById('loading-screen'),
            result: document.getElementById('result-screen'),
            tasks: document.getElementById('tasks-screen'),
            achievements: document.getElementById('achievements-screen'),
        };
        petVisual = document.getElementById('pet-visual');
        petName = document.getElementById('pet-name');
        levelText = document.getElementById('level-text');
        xpBar = document.getElementById('xp-bar');
        xpValue = document.getElementById('xp-value');
        seedCountText = document.getElementById('seed-count');
        plantInput = document.getElementById('plant-input');
        uploadedImage = document.getElementById('uploaded-image');
        plantNameResult = document.getElementById('plant-name-result');
        plantFact = document.getElementById('plant-fact');
        quizQuestion = document.getElementById('quiz-question');
        quizOptionsContainer = document.getElementById('quiz-options');
        modal = document.getElementById('modal');
        modalIcon = document.getElementById('modal-icon');
        modalTitle = document.getElementById('modal-title');
        modalMessage = document.getElementById('modal-message');
        modalCloseBtn = document.getElementById('modal-close-btn');

        // Add Event Listeners
        plantInput.addEventListener('change', handleFileSelect);
        navButtons.home.addEventListener('click', () => navigateTo('home'));
        navButtons.tasks.addEventListener('click', () => navigateTo('tasks'));
        navButtons.achievements.addEventListener('click', () => navigateTo('achievements'));
        
        // Initial setup
        checkDailyTasks();
        render();
        navigateTo('home');
    });
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>綠野尋蹤 Green Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .app-bg {
            background: linear-gradient(to bottom, #87CEEB 0%, #a8e0f7 70%, #98D8AA 70%, #8BC34A 100%);
            position: relative;
            overflow: hidden;
        }
        .main-content { z-index: 1; position: relative; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .modal-backdrop { transition: opacity 0.3s ease; opacity: 0; }
        .modal-backdrop.opacity-100 { opacity: 1; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        input[type="file"] { display: none; }
        .nav-item.active { color: #16a34a; /* emerald-600 */ }
        .achievement-unlocked { background-color: #d1fae5; border-color: #10b981; }
        .task-completed { text-decoration: line-through; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto h-[800px] max-h-[90vh] bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">

        <!-- Screens Container -->
        <div id="screen-container" class="flex-grow relative">
            <!-- 1. 主頁畫面 (Home Screen) -->
            <div id="home-screen" class="w-full h-full flex flex-col app-bg">
                <header class="p-4 flex justify-between items-center z-10">
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-4 py-1 flex items-center shadow">
                        <span id="level-text" class="font-bold text-emerald-700 mr-3">Lv.1</span>
                        <div class="w-24 bg-gray-300 rounded-full h-4"><div id="xp-bar" class="bg-gradient-to-r from-yellow-400 to-amber-500 h-4 rounded-full" style="width: 0%;"></div></div>
                        <span id="xp-value" class="text-xs font-bold text-gray-600 ml-2">0/10</span>
                    </div>
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-3 py-2 flex items-center shadow">
                        <span class="text-2xl">🌿</span>
                        <span id="seed-count" class="font-bold text-emerald-700 ml-2">10</span>
                    </div>
                </header>
                <main class="flex-grow flex flex-col justify-end items-center main-content pb-4">
                    <div class="pet-container text-center">
                        <img id="pet-visual" src="http://googleusercontent.com/file_content/1" alt="電子寵物" class="h-64 w-auto drop-shadow-lg">
                        <p id="pet-name" class="mt-2 text-xl font-bold text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.4)">小種籽</p>
                    </div>
                </main>
            </div>

            <!-- Other Screens (hidden by default) -->
            <div id="loading-screen" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-20">
                 <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-500"></div>
                 <p class="mt-4 text-lg text-gray-600 font-semibold">AI 正在努力辨識中...</p>
            </div>

            <div id="result-screen" class="hidden absolute inset-0 bg-gray-50 flex flex-col p-4 sm:p-6 z-20">
                <h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-4">分析結果與挑戰</h2>
                <div class="bg-white p-4 rounded-lg mb-4 text-center shadow-sm">
                    <img id="uploaded-image" src="" alt="上傳的植物圖片" class="max-h-40 w-auto mx-auto rounded-lg shadow-md mb-3">
                    <p class="text-sm text-gray-500">辨識結果：</p>
                    <p id="plant-name-result" class="text-lg font-bold text-emerald-600"></p>
                    <p id="plant-fact" class="text-sm mt-2 text-gray-700 bg-emerald-50 p-2 rounded-md"></p>
                </div>
                <div class="bg-amber-50 p-4 rounded-lg shadow-sm">
                    <p class="font-semibold text-amber-800 mb-3 text-center">💡 生態小測驗</p>
                    <p id="quiz-question" class="mb-4 text-center"></p>
                    <div id="quiz-options" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>

            <div id="tasks-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20">
                <h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">任務中心</h2>
                <div id="tasks-list"></div>
            </div>

            <div id="achievements-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20">
                 <h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">我的成就</h2>
                 <div id="achievements-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="w-full bg-gray-100/90 backdrop-blur-sm grid grid-cols-4 gap-1 p-2 border-t border-gray-200 z-10">
            <button id="nav-home" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg active"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span class="text-xs font-medium">主頁</span></button>
            <label for="plant-input" class="nav-item btn flex flex-col items-center text-gray-600 p-1 rounded-lg cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg><span class="text-xs font-medium">餵飼</span></label>
            <input type="file" id="plant-input" accept="image/*">
            <button id="nav-tasks" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg><span class="text-xs font-medium">任務</span></button>
            <button id="nav-achievements" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v4m-2-2h4m6 4v4m-2-2h4M17 3l-1.5 1.5M21 7l-1.5-1.5M17 21l-1.5-1.5M21 17l-1.5 1.5M3 7l1.5-1.5M7 3l1.5 1.5M3 17l1.5 1.5M7 21l1.5-1.5" /></svg><span class="text-xs font-medium">成就</span></button>
        </nav>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm mx-auto transform scale-95 opacity-0">
            <div id="modal-icon" class="text-6xl mb-4"></div><h3 id="modal-title" class="text-2xl font-bold mb-2"></h3><p id="modal-message" class="text-gray-600 mb-6"></p><button id="modal-close-btn" class="btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-full">繼續</button>
        </div>
    </div>

<script>
    // --- Game State ---
    let gameState = {
        level: 1,
        xp: 0,
        seeds: 10,
        pet: {
            stage: 'seed',
            name: '小種籽',
            visual: 'http://googleusercontent.com/file_content/1',
        },
        stats: {
            feeds: 0,
            correctAnswers: 0,
        },
        tasks: {
            dailyFeed: {
                description: "每日餵飼寵物一次",
                reward: 5, // 5 seeds
                completedToday: false,
                claimedToday: false,
                lastFeedDate: null,
            }
        },
        achievements: {
            firstAnswer: { name: "初為人師", description: "第一次成功回答問題", target: 1, progress: 0, unlocked: false, metric: 'correctAnswers' },
            feedThreeTimes: { name: "小小農夫", description: "累計餵飼寵物 3 次", target: 3, progress: 0, unlocked: false, metric: 'feeds' },
            reachLevelTwo: { name: "初窺門徑", description: "寵物達到 2 級", target: 2, progress: 1, unlocked: false, metric: 'level' },
        },
        currentQuiz: null,
        isProcessing: false,
    };

    // --- DOM Element Variables (will be assigned on DOMContentLoaded) ---
    let navButtons, screens, petVisual, petName, levelText, xpBar, xpValue,
        seedCountText, plantInput, uploadedImage, plantNameResult,
        plantFact, quizQuestion, quizOptionsContainer, modal, modalIcon,
        modalTitle, modalMessage, modalCloseBtn;

    // --- Helper Functions ---
    const calculateXpToNextLevel = (level) => 8 + (2 * level);
    const getTodayString = () => new Date().toISOString().split('T')[0];

    // --- Navigation ---
    function navigateTo(screenName) {
        Object.values(screens).forEach(screen => {
            if (screen) screen.classList.add('hidden');
        });
        if (screens[screenName]) {
            screens[screenName].classList.remove('hidden');
        }

        Object.values(navButtons).forEach(btn => {
            if(btn) btn.classList.remove('active');
        });
        if (navButtons[screenName]) {
            navButtons[screenName].classList.add('active');
        }

        if (screenName === 'tasks') renderTasks();
        if (screenName === 'achievements') renderAchievements();
    }

    // --- Rendering ---
    function render() {
        const { level, xp, pet, seeds } = gameState;
        const xpToNextLevel = calculateXpToNextLevel(level);

        petVisual.src = pet.visual;
        petName.textContent = pet.name;
        levelText.textContent = `Lv.${level}`;
        seedCountText.textContent = seeds;
        xpValue.textContent = `${xp}/${xpToNextLevel}`;
        xpBar.style.width = `${Math.min((xp / xpToNextLevel) * 100, 100)}%`;
    }

    function renderTasks() {
        const list = document.getElementById('tasks-list');
        list.innerHTML = '';
        const task = gameState.tasks.dailyFeed;
        const taskEl = document.createElement('div');

        let buttonHtml;
        if (task.claimedToday) {
            buttonHtml = `<button class="btn px-4 py-2 rounded-full text-white bg-gray-400 cursor-not-allowed" disabled>已領取</button>`;
        } else if (task.completedToday) {
            buttonHtml = `<button id="claim-daily-feed" class="btn px-4 py-2 rounded-full text-white bg-green-500 hover:bg-green-600">領取</button>`;
        } else {
            buttonHtml = `<button class="btn px-4 py-2 rounded-full text-white bg-gray-400 cursor-not-allowed" disabled>未完成</button>`;
        }

        taskEl.className = `p-4 border rounded-lg shadow-sm ${task.claimedToday ? 'bg-gray-200' : 'bg-white'}`;
        taskEl.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-bold ${task.claimedToday ? 'task-completed' : ''}">${task.description}</p>
                    <p class="text-sm text-green-600">獎勵: ${task.reward} 🌿</p>
                </div>
                ${buttonHtml}
            </div>
        `;
        list.appendChild(taskEl);

        if (task.completedToday && !task.claimedToday) {
            document.getElementById('claim-daily-feed').addEventListener('click', claimDailyFeedReward);
        }
    }
    
    function claimDailyFeedReward() {
        const task = gameState.tasks.dailyFeed;
        if (task.completedToday && !task.claimedToday) {
            task.claimedToday = true;
            gameState.seeds += task.reward;
            showModal('🎉', '獎勵已領取！', `獲得 <b>${task.reward}</b> 🌿！`, () => {
                render();
                renderTasks();
            });
        }
    }

    function renderAchievements() {
        const list = document.getElementById('achievements-list');
        list.innerHTML = '';
        Object.values(gameState.achievements).forEach(ach => {
            const progress = Math.min(ach.progress, ach.target);
            const percentage = Math.floor((progress / ach.target) * 100);
            const achEl = document.createElement('div');
            achEl.className = `p-4 border rounded-lg shadow-sm ${ach.unlocked ? 'achievement-unlocked' : 'bg-white'}`;
            achEl.innerHTML = `
                <div class="flex items-center">
                    <div class="text-4xl mr-4">${ach.unlocked ? '🏆' : '⏳'}</div>
                    <div>
                        <p class="font-bold">${ach.name}</p>
                        <p class="text-sm text-gray-600">${ach.description}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="bg-yellow-400 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-xs text-right text-gray-500 mt-1">${progress} / ${ach.target}</p>
                    </div>
                </div>
            `;
            list.appendChild(achEl);
        });
    }

    // --- Modals & Notifications ---
    function showModal(icon, title, message, onClose = () => {}) {
        modalIcon.textContent = icon;
        modalTitle.textContent = title;
        modalMessage.innerHTML = message;
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('opacity-100');
            modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
        }, 10);
        const closeHandler = () => {
            hideModal();
            onClose();
            modalCloseBtn.removeEventListener('click', closeHandler);
        };
        modalCloseBtn.addEventListener('click', closeHandler);
    }
    function hideModal() {
        modal.classList.remove('opacity-100');
        modal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
        modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // --- Core Game Logic ---
    async function handleFileSelect(event) {
        if (gameState.isProcessing) return;
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            gameState.isProcessing = true;
            navigateTo('loading');

            gameState.stats.feeds++;
            checkAchievements('feeds', gameState.stats.feeds);
            const dailyFeedTask = gameState.tasks.dailyFeed;
            if (!dailyFeedTask.completedToday) {
                dailyFeedTask.completedToday = true;
                dailyFeedTask.lastFeedDate = getTodayString();
                setTimeout(() => showModal('🔔', '任務進度更新', '您已完成「每日餵飼」任務，記得到任務中心領取獎勵！'), 500);
            }
            render();

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                uploadedImage.src = reader.result;
                await identifyPlantAndCreateQuiz(base64Data);
            };
            reader.readAsDataURL(file);
        }
        event.target.value = '';
    }
    
    async function identifyPlantAndCreateQuiz(base64ImageData) {
        const prompt = `你是一位友善的植物學家和教育家。請辨識這張圖片中的主要植物，並提供以下資訊：
        1.  **植物名稱**：提供最可能的中文名稱。
        2.  **趣味知識**：提供一個關於此植物或相關生態的簡短、有趣的知識點（約30-50字）。
        3.  **生態測驗**：根據這個知識點或相關主題，設計一個簡單的單選題，包含一個正確答案和兩個明顯錯誤的答案。

        請嚴格按照以下JSON格式回傳，不要包含任何額外的文字或Markdown標記：
        {
          "plantName": "植物的中文名稱",
          "funFact": "一段簡短有趣的知識。",
          "quiz": {
            "question": "測驗問題的文字",
            "options": ["選項A", "選項B", "正確答案C"],
            "correctAnswerIndex": 2
          }
        }`;
        const API_KEY = ""; // Provided by environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const payload = {
            contents: [{
                role: "user",
                parts: [
                    { text: prompt },
                    { inlineData: { mimeType: "image/png", data: base64ImageData } }
                ]
            }],
            generationConfig: { responseMimeType: "application/json" }
        };
        try {
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`);
            const result = await response.json();
            const data = JSON.parse(result.candidates[0].content.parts[0].text);
            gameState.currentQuiz = data.quiz;
            displayResultAndQuiz(data);
        } catch (error) {
            console.error("API 處理錯誤:", error);
            showModal('😢', '分析失敗', '無法辨識圖片中的植物，請換一張更清晰的照片試試看。', () => {
                navigateTo('home');
                gameState.isProcessing = false;
            });
        }
    }

    function displayResultAndQuiz(data) {
        plantNameResult.textContent = data.plantName || "生態知識";
        plantFact.textContent = data.funFact || "準備好接受挑戰了嗎？";
        quizQuestion.textContent = data.quiz.question;
        quizOptionsContainer.innerHTML = '';
        data.quiz.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.textContent = option;
            button.className = 'btn w-full text-left p-3 bg-white hover:bg-amber-100 rounded-lg border border-amber-200';
            button.onclick = () => handleQuizAnswer(index);
            quizOptionsContainer.appendChild(button);
        });
        navigateTo('result');
        gameState.isProcessing = false;
    }

    function handleQuizAnswer(selectedIndex) {
        if (gameState.isProcessing) return;
        gameState.isProcessing = true;
        const isCorrect = selectedIndex === gameState.currentQuiz.correctAnswerIndex;
        if (isCorrect) {
            const xpReward = 2;
            gameState.xp += xpReward;
            gameState.stats.correctAnswers++;
            checkAchievements('correctAnswers', gameState.stats.correctAnswers);
            showModal('🎉', '答對了！', `太棒了！獲得了 <b>${xpReward}</b> 點經驗值。`, () => {
                checkLevelUp();
                navigateTo('home');
                gameState.isProcessing = false;
            });
        } else {
            showModal('🤔', '差一點！', '別灰心，再接再厲！', () => {
                navigateTo('home');
                gameState.isProcessing = false;
            });
        }
        render();
    }

    function checkLevelUp() {
        let xpToNextLevel = calculateXpToNextLevel(gameState.level);
        while (gameState.xp >= xpToNextLevel) {
            gameState.level++;
            gameState.xp -= xpToNextLevel;
            checkAchievements('level', gameState.level);
            showModal('🏆', '等級提升！', `恭喜升到 <b>Lv.${gameState.level}</b>！`);
            xpToNextLevel = calculateXpToNextLevel(gameState.level);
        }
    }

    function checkAchievements(metric, value) {
        Object.entries(gameState.achievements).forEach(([key, ach]) => {
            if (!ach.unlocked && ach.metric === metric) {
                ach.progress = value;
                if (ach.progress >= ach.target) {
                    ach.unlocked = true;
                    setTimeout(() => showModal('🌟', '成就解鎖！', `恭喜您達成「${ach.name}」！`), 500);
                }
            }
        });
    }
    
    function checkDailyTasks() {
        const today = getTodayString();
        const dailyFeedTask = gameState.tasks.dailyFeed;
        if (dailyFeedTask.lastFeedDate !== today) {
            dailyFeedTask.completedToday = false;
            dailyFeedTask.claimedToday = false;
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Assign DOM elements
        navButtons = {
            home: document.getElementById('nav-home'),
            tasks: document.getElementById('nav-tasks'),
            achievements: document.getElementById('nav-achievements'),
        };
        screens = {
            home: document.getElementById('home-screen'),
            loading: document.getElementById('loading-screen'),
            result: document.getElementById('result-screen'),
            tasks: document.getElementById('tasks-screen'),
            achievements: document.getElementById('achievements-screen'),
        };
        petVisual = document.getElementById('pet-visual');
        petName = document.getElementById('pet-name');
        levelText = document.getElementById('level-text');
        xpBar = document.getElementById('xp-bar');
        xpValue = document.getElementById('xp-value');
        seedCountText = document.getElementById('seed-count');
        plantInput = document.getElementById('plant-input');
        uploadedImage = document.getElementById('uploaded-image');
        plantNameResult = document.getElementById('plant-name-result');
        plantFact = document.getElementById('plant-fact');
        quizQuestion = document.getElementById('quiz-question');
        quizOptionsContainer = document.getElementById('quiz-options');
        modal = document.getElementById('modal');
        modalIcon = document.getElementById('modal-icon');
        modalTitle = document.getElementById('modal-title');
        modalMessage = document.getElementById('modal-message');
        modalCloseBtn = document.getElementById('modal-close-btn');

        // Add Event Listeners
        plantInput.addEventListener('change', handleFileSelect);
        navButtons.home.addEventListener('click', () => navigateTo('home'));
        navButtons.tasks.addEventListener('click', () => navigateTo('tasks'));
        navButtons.achievements.addEventListener('click', () => navigateTo('achievements'));
        
        // Initial setup
        checkDailyTasks();
        render();
        navigateTo('home');
    });
</script>

</body>
</html>

